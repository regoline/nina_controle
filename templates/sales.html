{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <h2 class="text-3xl font-bold text-primary mb-6">
        <i class="fas fa-cash-register mr-2"></i>Vendas
    </h2>

    <div class="card mb-6">
		<div class="card-header bg-secondary text-white cursor-pointer" id="newSaleHeader">
			<h4><i class="fas fa-plus-circle mr-2"></i>Nova Venda</h4>
		</div>
		<div class="card-body hidden transition-all duration-300 ease-in-out" id="newSaleForm">
            <form method="POST" action="{{ url_for('add_sale') }}">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">
                        <i class="fas fa-user text-primary mr-2"></i>Nome do Cliente
                    </label>
                    <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-secondary" 
                           id="customer_name" name="customer_name">
                </div>
                
                <div id="recipe-items" class="space-y-4">
                    <div class="recipe-item border p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-6">
                                <label class="block text-gray-700 mb-2">
                                    <i class="fas fa-utensils text-primary mr-2"></i>Receita
                                </label>
                                <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-secondary recipe-select" 
                                        name="recipe_id[]" required>
                                    <option value="">Selecione uma receita</option>
                                    {% for recipe in recipes %}
                                    <option value="{{ recipe[0] }}">{{ recipe[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-gray-700 mb-2">
                                    <i class="fas fa-hashtag text-primary mr-2"></i>Quantidade
                                </label>
                                <input type="number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-secondary quantity" 
                                       name="quantity[]" min="1" value="1" required>
                            </div>
                            <div class="md:col-span-2 flex items-end">
                                <button type="button" class="remove-recipe w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-opacity-90 hidden">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 mb-6">
                    <button type="button" id="add-recipe" 
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-opacity-90">
                        <i class="fas fa-plus mr-2"></i>Adicionar Outra Receita
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-medium text-gray-700 mb-2">
                            <i class="fas fa-calculator text-primary mr-2"></i>Resumo de Valores
                        </h5>
                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span id="price_preview">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Custo de Entrega:</span>
                                <span id="delivery_preview">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between font-bold border-t pt-2 mt-2">
                                <span>Total:</span>
                                <span id="total_preview">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">
                                <i class="fas fa-truck text-primary mr-2"></i>Custo de Entrega (R$)
                            </label>
                            <input type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-secondary" 
                                   id="delivery_cost" name="delivery_cost" placeholder="0,00" value="0,00">
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-secondary rounded focus:ring-secondary" 
                                   id="is_delivered" name="is_delivered">
                            <label for="is_delivered" class="ml-2 text-gray-700">Entregue</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-secondary rounded focus:ring-secondary" 
                                   id="is_paid" name="is_paid">
                            <label for="is_paid" class="ml-2 text-gray-700">Pago</label>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="date" value="{{ datetime.now().strftime('%d/%m/%Y') }}">
                
                <div class="flex flex-wrap gap-2">
                    <button type="submit" class="bg-secondary text-white px-6 py-2 rounded-lg hover:bg-opacity-90">
                        <i class="fas fa-save mr-2"></i>Salvar Venda
                    </button>
                    <a href="{{ url_for('sales') }}" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-opacity-90">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

     <div class="card mb-6">
        <div class="card-header bg-red-500 text-white">
            <h4><i class="fas fa-exclamation-triangle mr-2"></i>Vendas Pendentes (Não Entregues)</h4>
        </div>
        <div class="card-body">
            {% set pending_sales = sales | selectattr("3", "equalto", False) | list %}
            {% if pending_sales %}
                <!-- Mobile Cards View -->
                <div class="md:hidden space-y-4">
                    {% for sale in pending_sales %}
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <!-- [Same mobile card content as before, but with red border] -->
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</div>
                                <div class="text-gray-600">{{ sale[1] if sale[1] else 'Cliente não informado' }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</div>
                                <div class="flex space-x-1 mt-1">
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                       class="text-red-600 hover:text-opacity-80 p-1"
                                       title="Marcar como entregue">
                                        <i class="fas fa-truck"></i>
                                    </a>
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                       class="text-{% if sale[4] %}green-600{% else %}red-600{% endif %} hover:text-opacity-80 p-1"
                                       title="{% if sale[4] %}Marcar como não pago{% else %}Marcar como pago{% endif %}">
                                        <i class="fas fa-dollar-sign"></i>
                                    </a>
                                    
                                    <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
									   class="text-primary hover:text-secondary p-1"
									   title="Editar">
										<i class="fas fa-edit"></i>
									</a>
									<a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
									   class="text-red-500 hover:text-red-700 p-1"
									   title="Excluir">
										<i class="fas fa-trash-alt"></i>
									</a>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t">
							<h5 class="font-medium mb-1">Itens:</h5>
							<ul class="text-sm space-y-1">
								{% for item in sale_items if item[0] == sale[0] %}
								<li>{{ item[2] }} ({{ item[1] }})</li>
								{% endfor %}
							</ul>
						</div>
						<!-- End of sale items details -->
						<div class="mt-2 pt-2 border-t text-sm">
							<div class="flex justify-between">
								<span>Status:</span>
								<span>
									<span class="text-red-600">Não Entregue</span>
								</span>
							</div>
						</div>
					</div>
                    {% endfor %}
                </div>
                
                <!-- Desktop Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b bg-red-50">
                                <th class="text-left py-3 px-2">Data</th>
                                <th class="text-left py-3 px-2">Cliente</th>
                                <th class="text-left py-3 px-2">Itens</th>
                                <th class="text-left py-3 px-2">Total</th>
                                <th class="text-left py-3 px-2">Status</th>
                                <th class="text-left py-3 px-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in pending_sales %}
                            <tr class="border-b hover:bg-red-50">
                                <!-- [Same table row content as before, but with truck and dollar icons] -->
                                <td class="py-3 px-2">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</td>
                                <td class="py-3 px-2">{{ sale[1] if sale[1] else '-' }}</td>
                                <td class="py-3 px-2">
                                    {% for item in sale_items if item[0] == sale[0] %}
                                    {{ item[2] }} ({{ item[1] }})<br>
                                    {% endfor %}
                                </td>
                                <td class="py-3 px-2">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</td>
                                <td class="py-3 px-2">
                                    <span class="badge bg-warning">Não Entregue</span>
                                    <span class="badge bg-{% if sale[4] %}success{% else %}danger{% endif %}">
                                        {% if sale[4] %}Pago{% else %}Não pago{% endif %}
                                    </span>
                                </td>
                                <td class="py-3 px-2">
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
                                           class="text-primary hover:text-secondary p-1"
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
                                           class="text-red-500 hover:text-red-700 p-1"
                                           title="Excluir">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                           class="text-red-600 hover:text-opacity-80 p-1"
                                           title="Marcar como entregue">
                                            <i class="fas fa-truck"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                           class="text-{% if sale[4] %}green-600{% else %}red-600{% endif %} hover:text-opacity-80 p-1"
                                           title="{% if sale[4] %}Marcar como não pago{% else %}Marcar como pago{% endif %}">
                                            <i class="fas fa-dollar-sign"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            
                            
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4 text-gray-500">
                    Nenhuma venda pendente encontrada
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-yellow-600 text-white">
            <h4><i class="fas fa-exclamation-circle mr-2"></i>Vendas Entregues (Não Pagas)</h4>
        </div>
        <div class="card-body">
            {% set delivered_unpaid_sales = sales | selectattr("3", "equalto", True) | selectattr("4", "equalto", False) | list %}
            {% if delivered_unpaid_sales %}
                <!-- [Same structure as pending sales, but with amber colors] -->
                <!-- Mobile Cards View -->
                <div class="md:hidden space-y-4">
                    {% for sale in delivered_unpaid_sales %}
                    <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg">
                        <!-- [Same mobile card content as before, but with amber border] -->
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</div>
                                <div class="text-gray-600">{{ sale[1] if sale[1] else 'Cliente não informado' }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</div>
                                <div class="flex space-x-1 mt-1">
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                       class="text-green-600 hover:text-opacity-80 p-1"
                                       title="Marcar como não entregue">
                                        <i class="fas fa-truck"></i>
                                    </a>
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                       class="text-red-600 hover:text-opacity-80 p-1"
                                       title="Marcar como pago">
                                        <i class="fas fa-dollar-sign"></i>
                                    </a>
                                    
                                     <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
									   class="text-primary hover:text-secondary p-1"
									   title="Editar">
										<i class="fas fa-edit"></i>
									</a>
									<a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
									   class="text-red-500 hover:text-red-700 p-1"
									   title="Excluir">
										<i class="fas fa-trash-alt"></i>
									</a>
                                    
                                </div>
                            </div>
                        </div>
                        <!-- [Rest of mobile card content] -->
                        <div class="mt-3 pt-3 border-t">
							<h5 class="font-medium mb-1">Itens:</h5>
							<ul class="text-sm space-y-1">
								{% for item in sale_items if item[0] == sale[0] %}
								<li>{{ item[2] }} ({{ item[1] }})</li>
								{% endfor %}
							</ul>
						</div>
						<!-- End of sale items details -->
						<div class="mt-2 pt-2 border-t text-sm">
							<div class="flex justify-between">
								<span>Status:</span>
								<span>
									<span class="text-amber-600">Entregue</span>, 
									<span class="text-red-600">Não pago</span>
								</span>
							</div>
						</div>
					</div>
  
                 
                    {% endfor %}
                </div>
                
                <!-- Desktop Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b bg-amber-50">
                                <th class="text-left py-3 px-2">Data</th>
                                <th class="text-left py-3 px-2">Cliente</th>
                                <th class="text-left py-3 px-2">Itens</th>
                                <th class="text-left py-3 px-2">Total</th>
                                <th class="text-left py-3 px-2">Status</th>
                                <th class="text-left py-3 px-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in delivered_unpaid_sales %}
                            <tr class="border-b hover:bg-amber-50">
                                <!-- [Same table row content as before, but with truck and dollar icons] -->
                                <td class="py-3 px-2">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</td>
                                <td class="py-3 px-2">{{ sale[1] if sale[1] else '-' }}</td>
                                <td class="py-3 px-2">
                                    {% for item in sale_items if item[0] == sale[0] %}
                                    {{ item[2] }} ({{ item[1] }})<br>
                                    {% endfor %}
                                </td>
                                <td class="py-3 px-2">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</td>
                                <td class="py-3 px-2">
                                    <span class="badge bg-success">Entregue</span>
                                    <span class="badge bg-danger">Não pago</span>
                                </td>
                                <td class="py-3 px-2">
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
                                           class="text-primary hover:text-secondary p-1"
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
                                           class="text-red-500 hover:text-red-700 p-1"
                                           title="Excluir">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                           class="text-green-600 hover:text-opacity-80 p-1"
                                           title="Marcar como não entregue">
                                            <i class="fas fa-truck"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                           class="text-red-600 hover:text-opacity-80 p-1"
                                           title="Marcar como pago">
                                            <i class="fas fa-dollar-sign"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4 text-gray-500">
                    Nenhuma venda entregue não paga encontrada
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-green-500 text-white">
            <h4><i class="fas fa-check-circle mr-2"></i>Vendas Concluídas (Entregues e Pagas)</h4>
        </div>
        <div class="card-body">
            {% set completed_sales = sales | selectattr("3", "equalto", True) | selectattr("4", "equalto", True) | list %}
            {% if completed_sales %}
                <!-- Pagination Controls -->
                {% set per_page = 10 %}
                {% set page = request.args.get('page', 1)|int %}
                {% set total_pages = (completed_sales|length / per_page)|round(0, 'ceil')|int %}
                {% set paginated_sales = completed_sales[(page-1)*per_page : page*per_page] %}
                
                <div class="flex justify-between items-center mb-4">
                    <div class="text-sm text-gray-600">
                        Página {{ page }} de {{ total_pages }} - Total: {{ completed_sales|length }} vendas
                    </div>
                    <div class="flex space-x-1">
                        {% if page > 1 %}
                        <a href="?page={{ page-1 }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% for p in range(1, total_pages+1) %}
                            {% if p == page %}
                            <span class="px-3 py-1 bg-secondary text-white rounded">{{ p }}</span>
                            {% else %}
                            <a href="?page={{ p }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ p }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <a href="?page={{ page+1 }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Mobile Cards View -->
                <div class="md:hidden space-y-4">
                    {% for sale in paginated_sales %}
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                        <!-- [Same mobile card content as before, but with green border] -->
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</div>
                                <div class="text-gray-600">{{ sale[1] if sale[1] else 'Cliente não informado' }}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</div>
                                <div class="flex space-x-1 mt-1">
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                       class="text-green-600 hover:text-opacity-80 p-1"
                                       title="Marcar como não entregue">
                                        <i class="fas fa-truck"></i>
                                    </a>
                                    <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                       class="text-green-600 hover:text-opacity-80 p-1"
                                       title="Marcar como não pago">
                                        <i class="fas fa-dollar-sign"></i>
                                    </a>
                                    
                                     <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
									   class="text-primary hover:text-secondary p-1"
									   title="Editar">
										<i class="fas fa-edit"></i>
									</a>
									<a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
									   class="text-red-500 hover:text-red-700 p-1"
									   title="Excluir">
										<i class="fas fa-trash-alt"></i>
									</a>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t">
							<h5 class="font-medium mb-1">Itens:</h5>
							<ul class="text-sm space-y-1">
								{% for item in sale_items if item[0] == sale[0] %}
								<li>{{ item[2] }} ({{ item[1] }})</li>
								{% endfor %}
							</ul>
						</div>
						<!-- End of sale items details -->
						<div class="mt-2 pt-2 border-t text-sm">
							<div class="flex justify-between">
								<span>Status:</span>
								<span>
									<span class="text-green-600">Entregue</span>, 
									<span class="text-green-600">Pago</span>
								</span>
							</div>
						</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Desktop Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b bg-green-50">
                                <th class="text-left py-3 px-2">Data</th>
                                <th class="text-left py-3 px-2">Cliente</th>
                                <th class="text-left py-3 px-2">Itens</th>
                                <th class="text-left py-3 px-2">Total</th>
                                <th class="text-left py-3 px-2">Status</th>
                                <th class="text-left py-3 px-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in paginated_sales %}
                            <tr class="border-b hover:bg-green-50">
                                <!-- [Same table row content as before, but with truck and dollar icons] -->
                                <td class="py-3 px-2">{{ datetime.strptime(sale[5], '%Y-%m-%d').strftime('%d/%m/%Y') if sale[5] else '' }}</td>
                                <td class="py-3 px-2">{{ sale[1] if sale[1] else '-' }}</td>
                                <td class="py-3 px-2">
                                    {% for item in sale_items if item[0] == sale[0] %}
                                    {{ item[2] }} ({{ item[1] }})<br>
                                    {% endfor %}
                                </td>
                                <td class="py-3 px-2">R$ {{ "%.2f"|format(sale[2])|replace('.', ',') }}</td>
                                <td class="py-3 px-2">
                                    <span class="badge bg-success">Entregue</span>
                                    <span class="badge bg-success">Pago</span>
                                </td>
                                <td class="py-3 px-2">
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('edit_sale', sale_id=sale[0]) }}" 
                                           class="text-primary hover:text-secondary p-1"
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('delete_sale', sale_id=sale[0]) }}" 
                                           class="text-red-500 hover:text-red-700 p-1"
                                           title="Excluir">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='delivered') }}" 
                                           class="text-green-600 hover:text-opacity-80 p-1"
                                           title="Marcar como não entregue">
                                            <i class="fas fa-truck"></i>
                                        </a>
                                        <a href="{{ url_for('toggle_sale_status', sale_id=sale[0], status='paid') }}" 
                                           class="text-green-600 hover:text-opacity-80 p-1"
                                           title="Marcar como não pago">
                                            <i class="fas fa-dollar-sign"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls (bottom) -->
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-gray-600">
                        Página {{ page }} de {{ total_pages }} - Total: {{ completed_sales|length }} vendas
                    </div>
                    <div class="flex space-x-1">
                        {% if page > 1 %}
                        <a href="?page={{ page-1 }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% for p in range(1, total_pages+1) %}
                            {% if p == page %}
                            <span class="px-3 py-1 bg-secondary text-white rounded">{{ p }}</span>
                            {% else %}
                            <a href="?page={{ p }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ p }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <a href="?page={{ page+1 }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="text-center py-4 text-gray-500">
                    Nenhuma venda concluída encontrada
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recipeData = {};
    {% for recipe in recipes %}
    recipeData[{{ recipe[0] }}] = {
        unit_price: {{ recipe[2] }},
        box_price: {{ recipe[3] }}
    };
    {% endfor %}

    // Add new recipe row
    document.getElementById('add-recipe').addEventListener('click', function() {
        const newItem = document.querySelector('.recipe-item').cloneNode(true);
        newItem.querySelector('.recipe-select').value = '';
        newItem.querySelector('.quantity').value = '1';
        newItem.querySelector('.remove-recipe').classList.remove('hidden');
        document.getElementById('recipe-items').appendChild(newItem);
        
        // Add event listeners to new elements
        newItem.querySelector('.recipe-select').addEventListener('change', calculateTotal);
        newItem.querySelector('.quantity').addEventListener('input', calculateTotal);
        newItem.querySelector('.remove-recipe').addEventListener('click', function() {
            if (document.querySelectorAll('.recipe-item').length > 1) {
                this.closest('.recipe-item').remove();
                calculateTotal();
            }
        });
    });

    // Remove recipe row
    document.querySelectorAll('.remove-recipe').forEach(btn => {
        btn.addEventListener('click', function() {
            if (document.querySelectorAll('.recipe-item').length > 1) {
                this.closest('.recipe-item').remove();
                calculateTotal();
            }
        });
    });

    function calculateTotal() {
        let subtotal = 0;
        const recipeItems = document.querySelectorAll('.recipe-item');
        
        recipeItems.forEach(item => {
            const recipeId = parseInt(item.querySelector('.recipe-select').value);
            const quantity = parseInt(item.querySelector('.quantity').value) || 0;
            
            if (recipeId && quantity > 0 && recipeData[recipeId]) {
                const recipe = recipeData[recipeId];
                const boxes = Math.floor(quantity / 6);
                const units = quantity % 6;
                subtotal += (boxes * recipe.box_price) + (units * recipe.unit_price);
            }
        });
        
        let deliveryCost = document.getElementById('delivery_cost').value.replace(',', '.');
        deliveryCost = parseFloat(deliveryCost) || 0;
        const total = subtotal + deliveryCost;
        
        document.getElementById('price_preview').textContent = 
            'R$ ' + subtotal.toFixed(2).replace('.', ',');
        document.getElementById('delivery_preview').textContent = 
            'R$ ' + deliveryCost.toFixed(2).replace('.', ',');
        document.getElementById('total_preview').textContent = 
            'R$ ' + total.toFixed(2).replace('.', ',');
    }

    // Initialize calculation
    calculateTotal();
    
    // Add event listeners
    document.querySelectorAll('.recipe-select').forEach(select => {
        select.addEventListener('change', calculateTotal);
    });
    document.querySelectorAll('.quantity').forEach(input => {
        input.addEventListener('input', calculateTotal);
    });
    document.getElementById('delivery_cost').addEventListener('input', calculateTotal);
});
</script>
<script>
document.getElementById('newSaleHeader').addEventListener('click', function() {
    const form = document.getElementById('newSaleForm');
    form.classList.toggle('hidden');
    
    // Optional: Change the icon when toggled
    const icon = this.querySelector('i');
    if (form.classList.contains('hidden')) {
        icon.classList.remove('fa-minus-circle');
        icon.classList.add('fa-plus-circle');
    } else {
        icon.classList.remove('fa-plus-circle');
        icon.classList.add('fa-minus-circle');
    }
});
</script>
{% endblock %}
